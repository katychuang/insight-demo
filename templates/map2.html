<!--
kartograph.js example
-->

<!DOCTYPE html>
<html>
    <head>
        <script src="{{ url_for('static', filename='js/jquery.min.js') }}"></script>
        <script src="{{ url_for('static', filename='js/raphael.min.js') }}"></script>
        <script src="{{ url_for('static', filename='js/kartograph.js') }}"></script>
        <script src="{{ url_for('static', filename='js/chroma.min.js') }}"></script>
    </head>
    <body>
      <div style="position:relative; margin-top:30px;">
        <div id="map"></div>
         <div style="position:absolute;bottom:0px;left:20px;z-index:10">
            <label>Select shoe</label> 
            <div class="btn-group" style="display:inline-block">
               <button class="dataset btn-large btn btn-primary" data-val="jordans">Air Jordans</button>
               <button class="dataset btn-large btn" data-val="Yeezy">Yeezy</button>
               <button class="dataset btn-large btn" data-val="FlyKnit">FlyKnit</button>
            </div><div class="btn-group" style="display:none">
               <button class="year btn btn-primary">10/1</button>
               <button class="year btn">10/2</button>
            </div><div class="btn-group" style="display:none">
               <button class="type btn" data-val="" data-maxrad="50">Quantity</button>
               <button class="type btn btn-primary" data-val="Rate" data-maxrad="40">Density</button>
            </div>
         </div>
      </div>

    </body>
<script>
//var map = kartograph.map('#map');
</script>
<script type="text/javascript">
   $(function() {
      var map, c, scale, updateMap, symbols,
         key = 'jordans',
         maxRad = 30;
      c = $('#map');
      c.height(c.width()*.65);
      map = window.m = kartograph.map('#map');
      map.loadMap('/static/map-usa.svg', function() {
         map.addLayer('usa', {
            styles: {
               fill: '#dfdcdc',
               stroke: '#fff'
            }
         });
         $.getJSON('/api/zip', function(sneakers) {
            sneakers = sneakers.sort(function(a,b) {return a.zip - b.zip;}).slice(0, 150);
            $.each(sneakers, function(i,shoe) {
                  sneakers[shoe.shoe] = sneakers[shoe.zip];
                  console.log(shoe);
            });
            scale = kartograph.scale.linear(sneakers, key);
            colscale = chroma.scale(chroma.brewer.PiYG.slice().reverse());
            function symbolAttrs(d) {
               return {
                  r: Math.sqrt(scale(d[key]))*maxRad,
                  stroke: '#fff',
                  'stroke-width': scale(d[key])*1,
                  fill: colscale(scale(d[key])),
                  'fill-opacity': 0.5
               };
            }
/*
            symbols = map.addSymbols({
               type: kartograph.Bubble,
               data: sneakers,
               location: function(d) { return d.ll },
               attrs: symbolAttrs,
               title: function(d) { return $.trim(d.zip)+' ('+Math.round(d[key] * 100000)+' per 100k)'; }
            });*/
            map.addSymbols({
                type: kartograph.Bubble,
                data: [{ name: 'Seattle', lon: 122.3346, lat: 47.5998 }],
                location: function(d) { return [d.lon, d.lat] },
                text: function(d) { return d.shoe; },
                radius: function(d) { return 20; },
                style: 'fill:red'
            });
            updateMap = function() {
               key = $('.dataset.btn-primary').data('val')
                  + $('.year.btn-primary').html()
                  + $('.type.btn-primary').data('val');
               scale = kartograph.scale.linear(sneakers, key);
               symbols.update({
                  attrs: symbolAttrs,
                  title: function(d) { return $.trim(d.zip)+' ('+Math.round(d[key] * 100000)+' per 100k)'; }
               }, 500, 'backOut');
            }
         });
      });
      $('.btn').click(function(event) {
         var tgt = $(event.target), par = tgt.parent();
         $('.btn', par).removeClass('btn-primary');
         tgt.addClass('btn-primary');
         updateMap();
      });
   });
</script>
</html>

